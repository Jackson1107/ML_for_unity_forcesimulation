一、回测引擎更新日志1

作者: 陈卓杰
时间: 2018/10/12 12:03
改动文件：runBacktesting.py, ctaBacktesting.py, ctaTemplate.py
同时新增一个策略文件：strategy_DoubleMA.py

1、runBacktesting.py改动说明
(1) 使用的策略为双均线策略, 数据为数字货币XBT合约;
(2) 添加了合约保证金比例的设置, 初始资金的设置, 和策略名的设置


2、ctaBacktesing.py变动说明

(1) 大约1838行, initStrategy()函数：
删掉self.strategy.onInit(), 原因是此时初始化数据还没准备好, 执行策略的初始化没有意义。

连接数据库、初始化数据读取部分大改

(2) 在104行添加：self.dbCollection = None    # 数据库集合

(3) 在大约1733行 runBacktesting()函数里面添加：
        # 连接数据库
        host, port, log = loadMongoSetting()
        self.dbClient = pymongo.MongoClient(host, port)
        self.dbCollection = self.dbClient[self.dbName][self.symbol]
        
(4) 大约在1748行，runBacktesting()函数func = self.newTick之后全部修改为：
        self.output(u'开始回测')
        self.output(u'开始回放数据')

        # 初始化策略
        # 初始化数据的时间范围（前闭后开）
        flt = {'datetime': {'$gte': self.dataStartDate,
                            '$lt': self.strategyStartDate}}
        # 读取数据
        initCursor = self.dbCollection.find(flt).sort('datetime', pymongo.ASCENDING)
        self.initData = []
        for d in initCursor:
            data = dataClass()
            data.__dict__ = d
            self.initData.append(data)
        # 策略执行初始化
        self.strategy.onInit()
        self.strategy.inited = True
        self.output(u'策略初始化完成')

        # 策略启动
        self.strategy.onStart()
        self.strategy.trading = True
        self.output(u'策略启动完成')

        # 循环加载回放数据
        self.runHistoryDataFromMongo()

        self.output(u'数据回放结束')

(5) 大约在1770附近，runHistoryDataFromMongo()函数，删除前面的：
        host, port, log = loadMongoSetting()

        self.dbClient = pymongo.MongoClient(host, port)
        collection = self.dbClient[self.dbName][self.symbol]

        self.output(u'开始载入数据')
        
(6) runHistoryDataFromMongo()函数，大约1792行，修改为：
        testdays = (self.dataEndDate - self.strategyStartDate).days
  
(6) runHistoryDataFromMongo()函数，大约1800行，修改为：
            testday = self.strategyStartDate + timedelta(days=i)
            
(7) runHistoryDataFromMongo()函数，大约1809行，修改为：
            initCursor = self.dbCollection.find(flt).sort('datetime', pymongo.ASCENDING)
            
(8) 大约在2763行，calculateBacktestingResult(), 修改为：
        # 获取最小交易单位
        try:
            tradeUnit = self.strategy.fixedSize
        except:
            tradeUnit = 1  # 最小交易单位

        longid = EMPTY_STRING
        shortid = EMPTY_STRING


3、ctaTemplate.py变动说明

(1) 242行loadBar()函数修改为：
    #----------------------------------------------------------------------
    def loadBar(self):
        """读取bar数据"""
        return self.ctaEngine.loadBar()



二、回测引擎更新日志2

作者: 陈卓杰
时间: 2018/10/xx xx:xx
改动文件：runBacktesting.py, ctaBacktesting.py, ctaTemplate.py

1、runBacktesting.py

(1) 增加一个新的回测函数，runBacktestingSimple()，在1724行：
    # ----------------------------------------------------------------------
    def runBacktestingSimple(self):
        """简单回测模式, 所有数据一次循环"""
        # 更新设置期初资金
        self.capital = self.initCapital

        # 连接数据库
        host, port, log = loadMongoSetting()
        self.dbClient = pymongo.MongoClient(host, port)
        self.dbCollection = self.dbClient[self.dbName][self.symbol]

        # 首先根据回测模式，确认要使用的数据类
        if self.mode == self.BAR_MODE:
            dataClass = CtaBarData
            func = self.newBar
        else:
            dataClass = CtaTickData
            func = self.newTick

        self.output(u'开始回测')
        self.output(u'数据回放开始')

        # 初始化策略
        # 初始化数据的时间范围（前闭后开）
        flt = {'datetime': {'$gte': self.dataStartDate,
                            '$lt': self.strategyStartDate}}
        # 读取数据
        initCursor = self.dbCollection.find(flt).sort('datetime', pymongo.ASCENDING)
        self.initData = []
        for d in initCursor:
            data = dataClass()
            data.__dict__ = d
            self.initData.append(data)
        # 策略执行初始化
        self.strategy.onInit()
        self.strategy.inited = True
        self.output(u'策略初始化完成')

        # 策略启动
        self.strategy.onStart()
        self.strategy.trading = True
        self.output(u'策略启动完成')

        # 读取回测数据
        flt = {'datetime': {'$gte': self.strategyStartDate,
                            '$lte': self.dataEndDate}}
        dataCursor = self.dbCollection.find(flt).sort('datetime', pymongo.ASCENDING)
        for d in dataCursor:
            data = dataClass()
            data.__dict__ = d
            func(data)

        self.output(u'数据回放结束')

        # 断开数据库
        self.dbClient.close()

(2) 


















